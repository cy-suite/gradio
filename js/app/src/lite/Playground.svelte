<script lang="ts">
	import Index from "../Index.svelte";
	import type { ThemeMode } from "../types";
	import { mount_css as default_mount_css } from "../css";
	import type { api_factory } from "@gradio/client";
	import type { WorkerProxy } from "@gradio/wasm";
	import { SvelteComponent, createEventDispatcher } from "svelte";
	import Code from "@gradio/code";
	import ErrorDisplay from "./ErrorDisplay.svelte";
	import lightning from "../images/lightning.svg";
	import play from "../images/play.svg";

	export let autoscroll: boolean;
	export let version: string;
	export let initial_height: string;
	export let app_mode: boolean;
	export let is_embed: boolean;
	export let theme_mode: ThemeMode | null = "system";
	export let control_page_title: boolean;
	export let container: boolean;
	export let info: boolean;
	export let eager: boolean;
	export let mount_css: typeof default_mount_css = default_mount_css;
	export let client: ReturnType<typeof api_factory>["client"];
	export let upload_files: ReturnType<typeof api_factory>["upload_files"];
	export let worker_proxy: WorkerProxy | undefined = undefined;
	export let fetch_implementation: typeof fetch = fetch;
	export let EventSource_factory: (url: URL) => EventSource = (url) =>
		new EventSource(url);
	export let space: string | null;
	export let host: string | null;
	export let src: string | null;

	export let code: string | undefined;
	export let error_display: SvelteComponent | null;

	const dispatch = createEventDispatcher();

	let dummy_elem: any = { classList: { contains: () => false } };
	let dummy_gradio: any = { dispatch: (_) => {} };

	let loading_text = "";
	export let loaded = false;
	worker_proxy?.addEventListener("progress-update", (event) => {
		loading_text = (event as CustomEvent).detail + "...";
	});
	worker_proxy?.addEventListener("initialization-completed", (_) => {
		loaded = true;
	});

	$: loading_text;
	$: loaded;
</script>

<div class="w-full h-full">
	<div
		class="flex flex-col md:flex-row w-full h-full border border-gray-200 rounded-md"
	>
		<div class:md:border-r={loaded} class="code-editor grow flex-1">
			<div class="flex justify-between align-middle h-8 border-b px-2">
				<h3 class="pt-1 grow">app.py</h3>
				{#if !loaded}
					<div class="flex"></div>
					<div class="flex float-right items-center" style="color:#999b9e">
						<div class="loading-dot mx-2"></div>
						{loading_text}
					</div>
				{:else}
					<div class="flex"></div>
					<div class="flex items-center mx-2" style="color:#999b9e">
						<img src={lightning} class="w-4 h-4 m-0.5" />
						Interactive
					</div>
				{/if}
			</div>
			{#if loaded}
				<Code
					bind:value={code}
					label=""
					language="python"
					target={dummy_elem}
					gradio={dummy_gradio}
					lines={10}
					interactive={true}
				/>
			{:else}
				<Code
					bind:value={code}
					label=""
					language="python"
					target={dummy_elem}
					gradio={dummy_gradio}
					lines={10}
					interactive={loaded}
				/>
			{/if}
		</div>
		{#if loaded}
			<div class="preview flex flex-1 flex-col">
				<div class="flex justify-between align-middle h-8 border-b px-2">
					<button
						class="text-gray-500 font-bold px-2 pr-1 rounded float-right m-1 flex items-center"
						style="
                        background: #eff1f3;
                        font-weight: 500;

                        "
						on:click={() => {
							dispatch("code", { code });
						}}
					>
						Run
						<img src={play} class="w-3 h-3 m-0.5" />
					</button>
					<div class="flex float-right"></div>
				</div>
				{#if !error_display}
					<Index
						{autoscroll}
						{version}
						{initial_height}
						{app_mode}
						{is_embed}
						{theme_mode}
						{control_page_title}
						{container}
						{info}
						{eager}
						{mount_css}
						{client}
						{upload_files}
						bind:worker_proxy
						{fetch_implementation}
						{EventSource_factory}
						{space}
						{host}
						{src}
					/>
				{:else}
					<ErrorDisplay
						is_embed={error_display.is_embed}
						error={error_display.error}
					/>
				{/if}
			</div>
		{/if}
	</div>
</div>

<style>
	:global(div.code-editor div.block) {
		height: calc(100% - 2rem);
		border-radius: 0;
		border: none;
	}

	:global(div.code-editor div.block .cm-gutters) {
		background-color: white;
	}

	:global(div.code-editor div.block .cm-content) {
		width: 0;
	}

	:global(div.lite-demo div.gradio-container) {
		height: 100%;
		overflow-y: scroll;
		margin: 0 !important;
	}

	:global(.gradio-container) {
		max-width: none !important;
	}

	.code-editor :global(label) {
		display: none;
	}

	.code-editor :global(.codemirror-wrappper) {
		border-radius: var(--block-radius);
	}

	.code-editor :global(> .block) {
		border: none !important;
	}

	.code-editor :global(.cm-scroller) {
		height: 100% !important;
	}
	h3 {
		font-size: medium;
		font-weight: 400;
	}

	.loading-dot {
		position: relative;
		left: -9999px;
		width: 10px;
		height: 10px;
		border-radius: 5px;
		background-color: #fd7b00;
		color: #fd7b00;
		box-shadow: 9999px 0 0 -1px;
		animation: loading-dot 2s infinite linear;
		animation-delay: 0.25s;
	}
	@keyframes loading-dot {
		0% {
			box-shadow: 9999px 0 0 -1px;
		}
		50% {
			box-shadow: 9999px 0 0 2px;
		}
		100% {
			box-shadow: 9999px 0 0 -1px;
		}
	}
</style>
