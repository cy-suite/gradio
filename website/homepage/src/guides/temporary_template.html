<h1 id="using-flagging">Using Flagging</h1>

<h2 id="introduction">Introduction</h2>

<p>When you deploy or demo a machine learning model, you may find that it behaves differently than how you expected (e.g. the model makes an incorrect prediction) when a user tries it with their own data. Capturing these "hard" data points is important because it allows you to make you machine learning model more reliable and robust.</p>

<p>Gradio simplifies the collection of this data by including a FLAG button with every <code>Interface</code>. This allows your user or tester to easily send data back to you, whether the model is running locally or has been shared by setting <code>share=True</code>. </p>

<h2 id="the-flag-button">The <strong>Flag</strong> button</h2>

<p>Underneath the output interfaces, there is a button marked <strong>Flag</strong>. When a user testing your model sees input with interesting output, such as erroneous or unexpected model behaviour, they can flag the input for the interface creator to review. </p>

<p><img src="/assets/guides/flag_button.gif" alt="flag button" /></p>

<p>There are four parameters <code>gr.Interface</code> that control how flagging works. We will go over them in greater detail.</p>

<ul>
<li><code>allow_flagging</code>: this parameter can be set to either <code>"manual"</code>, <code>"auto"</code>, or <code>"never"</code>. <br />
<ul>
<li><code>manual</code>: users will see a button to flag, and events are only flagged when it's clicked.</li>
<li><code>auto</code>: users will not see a button to flag, but every event will be flagged automatically. </li>
<li><code>never</code>: users will not see a button to flag, and no event will be flagged. </li>
</ul></li>
<li><code>flagging_options</code>: this parameter can be either <code>None</code> (default) or a list of strings.
<ul>
<li>If <code>None</code>, then the user simply clicks on the <strong>Flag</strong> button and no additional options are shown.</li>
<li>If a list of strings are provided, this allows user to select from a list of options when flagging. Only applies if <code>allow_flagging</code> is <code>"manual"</code>.</li>
<li>The chosen option is then piped along with the input and output.</li>
</ul></li>
<li><code>flagging_dir</code>: this parameter takes a string.
<ul>
<li>It represents what to name the directory where flagged data is stored.</li>
</ul></li>
<li><code>flagging_callback</code>: this parameter takes an instance of a subclass of the <code>FlaggingCallback</code> class
<ul>
<li>Using this parameter allows you to write custom code that gets run when the flag button is clicked</li>
<li>By default, this is set to an instance of <code>gr.CSVLogger</code></li>
<li>One example is setting it to an instance of <code>gr.HuggingFaceDatasetSaver</code> which can allow you to pipe any flagged data into a HuggingFace Dataset.</li>
</ul></li>
</ul>

<h2 id="what-happens-to-flagged-data">What happens to flagged data?</h2>

<p>Within the directory provided by the <code>flagging_dir</code> argument, a CSV file will log the flagged data. </p>

<p>Here's an example: The code below creates the calculator interface embedded below it:</p>

<pre><code class='lang-python'>import gradio as gr


def calculator(num1, operation, num2):
    if operation == "add":
        return num1 + num2
    elif operation == "subtract":
        return num1 - num2
    elif operation == "multiply":
        return num1 * num2
    elif operation == "divide":
        return num1 / num2


iface = gr.Interface(
    calculator,
    ["number", gr.inputs.Radio(["add", "subtract", "multiply", "divide"]), "number"],
    "number",
    allow_flagging="manual"
)

iface.launch()
</code></pre>

<iframe src="https://hf.space/embed/aliabd/calculator-flag-basic/+" frameBorder="0" height="500" title="Gradio app" class="container p-0 flex-grow space-iframe" allow="accelerometer; ambient-light-sensor; autoplay; battery; camera; document-domain; encrypted-media; fullscreen; geolocation; gyroscope; layout-animations; legacy-image-formats; magnetometer; microphone; midi; oversized-images; payment; picture-in-picture; publickey-credentials-get; sync-xhr; usb; vr ; wake-lock; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-downloads"></iframe>

<p>When you click the flag button above, the directory where the interface was launched will include a new flagged subfolder, with a csv file inside it. This csv file includes all the data that was flagged. </p>

<pre><code class='lang-directory'>+-- flagged/
|   +-- logs.csv
</code></pre>

<p><em>flagged/logs.csv</em></p>

<pre><code class='lang-csv'>num1,operation,num2,Output,timestamp
5,add,7,12,2022-01-31 11:40:51.093412
6,subtract,1.5,4.5,2022-01-31 03:25:32.023542
</code></pre>

<p>If the interface involves file data, such as for Image and Audio components, folders will be created to store those flagged data as well. For example an <code>image</code> input to <code>image</code> output interface will create the following structure.</p>

<pre><code class='lang-directory'>+-- flagged/
|   +-- logs.csv
|   +-- image/
|   |   +-- 0.png
|   |   +-- 1.png
|   +-- Output/
|   |   +-- 0.png
|   |   +-- 1.png
</code></pre>

<p><em>flagged/logs.csv</em></p>

<pre><code class='lang-csv'>im,Output timestamp
im/0.png,Output/0.png,2022-02-04 19:49:58.026963
im/1.png,Output/1.png,2022-02-02 10:40:51.093412
</code></pre>

<p>If you wish for the user to provide a reason for flagging, you can pass a list of strings to the <code>flagging_options</code> argument of Interface. Users will have to select one of the strings when flagging, which will be saved as an additional column to the CSV.</p>

<p>If we go back to the calculator example, the following code will create the interface embedded below it.  </p>

<pre><code class='lang-python'>iface = gr.Interface(
    calculator,
    ["number", gr.inputs.Radio(["add", "subtract", "multiply", "divide"]), "number"],
    "number",
    allow_flagging="manual",
    flagging_options=["wrong sign", "off by one", "other"]
)

iface.launch()
</code></pre>

<iframe src="https://hf.space/embed/aliabd/calculator-flagging-options/+" frameBorder="0" height="500" title="Gradio app" class="container p-0 flex-grow space-iframe" allow="accelerometer; ambient-light-sensor; autoplay; battery; camera; document-domain; encrypted-media; fullscreen; geolocation; gyroscope; layout-animations; legacy-image-formats; magnetometer; microphone; midi; oversized-images; payment; picture-in-picture; publickey-credentials-get; sync-xhr; usb; vr ; wake-lock; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-downloads"></iframe>

<p>When users click the flag button, the csv file will now include a column indicating the selected option.</p>

<p><em>flagged/logs.csv</em></p>

<pre><code class='lang-csv'>num1,operation,num2,Output,flag,timestamp
5,add,7,-12,wrong sign,2022-02-04 11:40:51.093412
6,subtract,1.5,3.5,off by one,2022-02-04 11:42:32.062512
</code></pre>

<h2 id="doing-more-with-the-data">Doing more with the data</h2>

<p>Suppose you want to take some action on the flagged data, instead of just saving it. Perhaps you want to trigger your model to retrain, or even just share it with others in a cloud dataset. We've made this super easy with the <code>flagging_callback</code> parameter.</p>

<p>For example, below we're going to pipe flagged data from our calculator example into a crowd-sourced Hugging Face Dataset. </p>

<pre><code class='lang-python'>import os

HF_TOKEN = os.getenv('HF_TOKEN')
hf_writer = gr.HuggingFaceDatasetSaver(HF_TOKEN, "crowdsourced-calculator-demo")

iface = gr.Interface(
    calculator,
    ["number", gr.inputs.Radio(["add", "subtract", "multiply", "divide"]), "number"],
    "number",
    allow_flagging="manual",
    flagging_options=["wrong sign", "off by one", "other"],
    flagging_callback=hf_writer
)

iface.launch()
</code></pre>

<iframe src="https://hf.space/embed/aliabd/calculator-flagging-crowdsourced/+" frameBorder="0" height="500" title="Gradio app" class="container p-0 flex-grow space-iframe" allow="accelerometer; ambient-light-sensor; autoplay; battery; camera; document-domain; encrypted-media; fullscreen; geolocation; gyroscope; layout-animations; legacy-image-formats; magnetometer; microphone; midi; oversized-images; payment; picture-in-picture; publickey-credentials-get; sync-xhr; usb; vr ; wake-lock; xr-spatial-tracking" sandbox="allow-forms allow-modals allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-downloads"></iframe>

<p>You can now see all the examples flagged above in this <a rel="noopener" target="_blank" href="https://huggingface.co/datasets/aliabd/crowdsourced-calculator-demo/blob/main/data.csv">public HF dataset</a>.</p>

<p><img src="/assets/guides/flagging-callback-hf.png" alt="flagging callback hf" /></p>

<p>We created the <code>gr.HuggingFaceDatasetSaver</code> class, but you can pass your own custom class as long as it inherits from <code>FLaggingCallback</code> defined in <a rel="noopener" target="_blank" href="https://github.com/gradio-app/gradio/blob/master/gradio/flagging.py">this file</a>. If you create a cool callback, please contribute it to the repo! </p>

<h2 id="privacy">Privacy</h2>

<p>Please make sure your users understand when the data they submit is being saved, and what you plan on doing with it. This is especially important when you use <code>allow_flagging=auto</code>. We suggest including this info in the description so that it's read before the interface.</p>

<h3 id="thats-all-happy-building">That's all! Happy building :)</h3>
